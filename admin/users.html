<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management — GOAA Admin</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;800&family=Josefin+Sans:wght@300;400;600;700&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --garnet: #8B1A2E; --garnet-dark: #5C0F1C; --garnet-light: #B52340;
      --gold: #C9A84C; --gold-light: #E8C86A; --gold-pale: #F5E9C8;
      --cream: #FAF6EE; --dark: #1A1009; --mid: #3D2B1F;
      --text: #2C1A10; --text-light: #7A5C44; --border: #D4B896;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Libre Baskerville', Georgia, serif; background: var(--cream); color: var(--text); min-height: 100vh; }

    nav { background: var(--garnet-dark); border-bottom: 3px solid var(--gold); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; height: 64px; }
    .nav-brand { font-family: 'Playfair Display', serif; font-size: 1.05rem; font-weight: 800; color: var(--gold); text-decoration: none; display: flex; align-items: center; gap: 10px; }
    .nav-crest { width: 34px; height: 34px; background: var(--gold); clip-path: polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; color: var(--garnet-dark); }
    .nav-links { display: flex; gap: 2px; align-items: center; }
    .nav-links a { font-family: 'Josefin Sans', sans-serif; font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.65); text-decoration: none; padding: 7px 12px; border-radius: 2px; transition: background 0.2s, color 0.2s; }
    .nav-links a:hover, .nav-links a.active { background: rgba(201,168,76,0.12); color: var(--gold-light); }
    .nav-links a.logout { color: rgba(255,255,255,0.35); }

    .page { max-width: 1000px; margin: 0 auto; padding: 2.5rem 2rem; }
    .page-eyebrow { font-family: 'Josefin Sans', sans-serif; font-size: 10px; letter-spacing: 0.35em; text-transform: uppercase; color: var(--gold); margin-bottom: 0.4rem; }
    .page-title { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 800; color: var(--garnet-dark); margin-bottom: 0.4rem; }
    .page-sub { font-size: 0.875rem; color: var(--text-light); line-height: 1.7; margin-bottom: 2rem; }
    .page-sub strong { color: var(--mid); }

    .alert { padding: 0.9rem 1.25rem; border-left: 4px solid; margin-bottom: 1.5rem; font-size: 0.875rem; line-height: 1.6; display: none; }
    .alert.show { display: block; }
    .alert-error { background: #FEF2F2; border-color: var(--garnet); color: var(--garnet-dark); }
    .alert-success { background: #F0FDF4; border-color: #16A34A; color: #14532D; }

    #auth-gate { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 55vh; text-align: center; gap: 1.25rem; }
    .auth-msg { font-family: 'Playfair Display', serif; font-size: 1.25rem; color: var(--mid); }
    .auth-sub { font-size: 0.875rem; color: var(--text-light); max-width: 380px; }
    .btn-login { font-family: 'Josefin Sans', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; padding: 12px 28px; background: var(--gold); color: var(--garnet-dark); border: none; cursor: pointer; }
    .btn-login:hover { background: var(--gold-light); }

    .table-wrap { background: #fff; border: 1px solid var(--border); overflow: hidden; }
    .table-toolbar { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
    .user-count { font-family: 'Josefin Sans', sans-serif; font-size: 11px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-light); }
    .search-box { font-family: 'Josefin Sans', sans-serif; font-size: 12px; padding: 7px 12px; border: 1px solid var(--border); background: var(--cream); color: var(--text); outline: none; width: 220px; }
    .search-box:focus { border-color: var(--garnet); }

    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--garnet-dark); }
    thead th { font-family: 'Josefin Sans', sans-serif; font-size: 9px; font-weight: 600; letter-spacing: 0.2em; text-transform: uppercase; color: var(--gold); padding: 0.8rem 1.25rem; text-align: left; white-space: nowrap; }
    tbody tr { border-bottom: 1px solid var(--border); transition: background 0.12s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--gold-pale); }
    td { padding: 0.85rem 1.25rem; font-size: 0.875rem; vertical-align: middle; }
    .td-email { font-weight: 600; color: var(--dark); }
    .td-date { font-family: 'Josefin Sans', sans-serif; font-size: 10px; color: var(--text-light); white-space: nowrap; }

    .badge { display: inline-block; font-family: 'Josefin Sans', sans-serif; font-size: 9px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; padding: 3px 8px; border-radius: 2px; }
    .badge-admin  { background: var(--garnet-dark); color: var(--gold); }
    .badge-alumni { background: var(--gold-pale); color: var(--mid); }
    .badge-member { background: #E0F2FE; color: #0369A1; }
    .badge-none   { background: #F3F4F6; color: #6B7280; }

    .role-editor { display: flex; align-items: center; gap: 8px; }
    .role-select { font-family: 'Josefin Sans', sans-serif; font-size: 11px; padding: 6px 10px; border: 1px solid var(--border); background: #fff; color: var(--text); cursor: pointer; outline: none; }
    .role-select:focus { border-color: var(--garnet); }
    .btn-save { font-family: 'Josefin Sans', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 6px 14px; background: var(--garnet); color: #fff; border: none; cursor: pointer; transition: opacity 0.2s; white-space: nowrap; }
    .btn-save:hover { opacity: 0.85; }
    .btn-save:disabled { background: var(--border); cursor: not-allowed; }
    .save-status { font-family: 'Josefin Sans', sans-serif; font-size: 10px; font-weight: 600; white-space: nowrap; }
    .save-status.ok  { color: #16A34A; }
    .save-status.err { color: var(--garnet); }
    .save-status.saving { color: var(--gold); }

    .loading-row td { text-align: center; padding: 3rem; color: var(--text-light); font-family: 'Josefin Sans', sans-serif; font-size: 11px; letter-spacing: 0.2em; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--garnet); border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .invite-section { margin-top: 2.5rem; background: #fff; border: 1px solid var(--border); padding: 2rem; }
    .invite-title { font-family: 'Josefin Sans', sans-serif; font-size: 10px; letter-spacing: 0.3em; text-transform: uppercase; color: var(--gold); margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border); }
    .invite-row { display: flex; gap: 0.75rem; align-items: flex-end; flex-wrap: wrap; }
    .invite-group { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 200px; }
    .invite-label { font-family: 'Josefin Sans', sans-serif; font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-light); }
    .invite-input { border: 1px solid var(--border); background: var(--cream); color: var(--text); padding: 9px 12px; font-family: 'Libre Baskerville', serif; font-size: 0.875rem; outline: none; width: 100%; }
    .invite-input:focus { border-color: var(--garnet); background: #fff; }
    .btn-invite { font-family: 'Josefin Sans', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 10px 22px; background: var(--garnet-dark); color: var(--gold); border: none; cursor: pointer; white-space: nowrap; transition: background 0.2s; }
    .btn-invite:hover { background: var(--garnet); }
    .invite-note { font-family: 'Josefin Sans', sans-serif; font-size: 10px; color: var(--text-light); margin-top: 0.75rem; line-height: 1.6; }
  </style>
</head>
<body>

<nav>
  <a href="/" class="nav-brand"><div class="nav-crest">ΠΚΑ</div> GOAA Admin</a>
  <div class="nav-links">
    <a href="/admin/">CMS Editor</a>
    <a href="/admin/users.html" class="active">Users</a>
    <a href="/">View Site</a>
    <a href="#" class="logout" id="logout-btn">Log Out</a>
  </div>
</nav>

<div class="page">

  <!-- AUTH GATE -->
  <div id="auth-gate" style="display:none;">
    <div class="auth-msg" id="auth-msg">Admin access required</div>
    <div class="auth-sub" id="auth-sub">You must be logged in with an admin account to manage users.</div>
    <button class="btn-login" id="login-btn">Log In</button>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main-content" style="display:none;">
    <div class="page-eyebrow">Administration</div>
    <h1 class="page-title">User Management</h1>
    <p class="page-sub">
      Manage who can log in to the <strong>CMS editor</strong> and what they can do.<br>
      <strong>admin</strong> — full CMS access, can edit all site content &amp; manage users &nbsp;|&nbsp;
      <strong>alumni</strong> — verified alumni (future use) &nbsp;|&nbsp;
      <strong>member</strong> — active chapter member (future use)
    </p>

    <div class="alert alert-error" id="page-error"></div>
    <div class="alert alert-success" id="page-success"></div>

    <!-- User table -->
    <div class="table-wrap">
      <div class="table-toolbar">
        <span class="user-count" id="user-count">Loading users…</span>
        <input type="text" class="search-box" id="search-box" placeholder="Search by email…">
      </div>
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Current Role</th>
            <th>Change Role</th>
            <th>Joined</th>
          </tr>
        </thead>
        <tbody id="users-tbody">
          <tr class="loading-row"><td colspan="4"><span class="spinner"></span> &nbsp;Loading users…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Invite new admin -->
    <div class="invite-section">
      <div class="invite-title">Invite a New Admin User</div>
      <div class="invite-row">
        <div class="invite-group">
          <label class="invite-label">Email Address</label>
          <input type="email" class="invite-input" id="invite-email" placeholder="brother@example.com">
        </div>
        <button class="btn-invite" onclick="openInvite()">Send Invite via Netlify</button>
      </div>
      <p class="invite-note">
        New users must be invited through the <strong>Netlify Identity dashboard</strong>
        (Site → Identity → Invite users). After they accept, set their role to <strong>admin</strong> here.
      </p>
    </div>
  </div>

</div>

<script>
let currentUser = null;
let allUsers = [];

// ── AUTH ─────────────────────────────────────────────────────────
function init() {
  if (!window.netlifyIdentity) {
    showGate('Netlify Identity not available', 'This page requires Netlify hosting with Identity enabled.');
    return;
  }
  netlifyIdentity.on('init', user => {
    if (user) handleUser(user);
    else showGate('Admin access required', 'Log in with your admin account to manage users.');
  });
  netlifyIdentity.on('login', user => { netlifyIdentity.close(); handleUser(user); });
  netlifyIdentity.on('logout', () => {
    currentUser = null;
    showGate('Logged out', 'Log back in to continue.');
  });
  netlifyIdentity.init();
}

function handleUser(user) {
  currentUser = user;
  const roles = (user.app_metadata && user.app_metadata.roles) || [];
  if (!roles.includes('admin')) {
    showGate('Admin role required',
      `Logged in as ${user.email} — your account doesn't have the admin role yet. Ask an existing admin to set it.`);
    return;
  }
  document.getElementById('auth-gate').style.display = 'none';
  document.getElementById('main-content').style.display = 'block';
  loadUsers();
}

function showGate(msg, sub) {
  document.getElementById('auth-gate').style.display = 'flex';
  document.getElementById('main-content').style.display = 'none';
  document.getElementById('auth-msg').textContent = msg;
  document.getElementById('auth-sub').textContent = sub;
}

// ── LOAD USERS ───────────────────────────────────────────────────
async function loadUsers() {
  try {
    const token = currentUser.token.access_token;
    const res = await fetch('/.netlify/functions/list-users', {
      headers: { Authorization: `Bearer ${token}` },
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    allUsers = data.users || [];
    renderUsers(allUsers);
    document.getElementById('user-count').textContent =
      `${allUsers.length} user${allUsers.length !== 1 ? 's' : ''}`;
  } catch (err) {
    document.getElementById('users-tbody').innerHTML =
      `<tr class="loading-row"><td colspan="4" style="color:var(--garnet);">Error loading users: ${err.message}</td></tr>`;
  }
}

// ── RENDER TABLE ─────────────────────────────────────────────────
function renderUsers(users) {
  const tbody = document.getElementById('users-tbody');
  if (!users.length) {
    tbody.innerHTML = '<tr class="loading-row"><td colspan="4">No users found.</td></tr>';
    return;
  }
  const ROLES = ['admin', 'alumni', 'member'];
  tbody.innerHTML = users.map(u => {
    const roles = (u.app_metadata && u.app_metadata.roles) || [];
    const primary = roles[0] || '';
    const joined = u.created_at
      ? new Date(u.created_at).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' })
      : '—';
    const badge = primary
      ? `<span class="badge badge-${primary}">${primary}</span>`
      : `<span class="badge badge-none">no role</span>`;
    const options = ['', ...ROLES].map(r =>
      `<option value="${r}" ${primary === r ? 'selected' : ''}>${r || '(no role)'}</option>`
    ).join('');
    return `
      <tr data-uid="${u.id}">
        <td class="td-email">${u.email}</td>
        <td>${badge}</td>
        <td>
          <div class="role-editor">
            <select class="role-select" data-uid="${u.id}" onchange="onRoleChange(this)">${options}</select>
            <button class="btn-save" data-uid="${u.id}" onclick="saveRole('${u.id}')" disabled>Save</button>
            <span class="save-status" id="rs-${u.id}"></span>
          </div>
        </td>
        <td class="td-date">${joined}</td>
      </tr>`;
  }).join('');
}

function onRoleChange(select) {
  document.querySelector(`button[data-uid="${select.dataset.uid}"].btn-save`).disabled = false;
}

// ── SAVE ROLE ────────────────────────────────────────────────────
async function saveRole(userId) {
  const select = document.querySelector(`select[data-uid="${userId}"]`);
  const btn    = document.querySelector(`button[data-uid="${userId}"].btn-save`);
  const status = document.getElementById(`rs-${userId}`);
  const newRole = select.value;

  btn.disabled = true;
  status.textContent = 'Saving…'; status.className = 'save-status saving';

  try {
    const token = currentUser.token.access_token;
    const res = await fetch('/.netlify/functions/update-user-role', {
      method: 'POST',
      headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, newRoles: newRole ? [newRole] : [] }),
    });
    if (!res.ok) throw new Error((await res.json()).error || `HTTP ${res.status}`);

    // Update badge in place
    const row = document.querySelector(`tr[data-uid="${userId}"]`);
    row.querySelector('td:nth-child(2)').innerHTML = newRole
      ? `<span class="badge badge-${newRole}">${newRole}</span>`
      : `<span class="badge badge-none">no role</span>`;

    status.textContent = '✓ Saved'; status.className = 'save-status ok';
    setTimeout(() => { status.textContent = ''; }, 3000);
  } catch (err) {
    status.textContent = '✗ ' + err.message; status.className = 'save-status err';
    btn.disabled = false;
  }
}

// ── SEARCH ───────────────────────────────────────────────────────
document.getElementById('search-box').addEventListener('input', function () {
  const q = this.value.toLowerCase();
  renderUsers(allUsers.filter(u => (u.email || '').toLowerCase().includes(q)));
  document.getElementById('user-count').textContent = document.querySelectorAll('#users-tbody tr[data-uid]').length + ' users';
});

// ── INVITE (opens Netlify dashboard) ─────────────────────────────
function openInvite() {
  const email = document.getElementById('invite-email').value.trim();
  if (!email) { alert('Enter an email address first.'); return; }
  const url = `https://app.netlify.com/sites/YOUR-SITE-NAME/identity`;
  window.open(url, '_blank');
}

// ── LOGOUT ───────────────────────────────────────────────────────
document.getElementById('login-btn').addEventListener('click', () => netlifyIdentity.open('login'));
document.getElementById('logout-btn').addEventListener('click', e => { e.preventDefault(); netlifyIdentity.logout(); });

init();
</script>
</body>
</html>
